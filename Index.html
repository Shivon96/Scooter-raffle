<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RapidRepair POS System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Inter font and custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'indigo-pos': '#4338ca',
                        'emerald-pos': '#10b981',
                        'gray-bg': '#f3f4f6',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Base styles to ensure full height and smooth scrolling */
        body {
            font-family: 'Inter', sans-serif;
        }
        .scrollable-area {
            height: calc(100vh - 64px); /* Subtract header height */
            overflow-y: auto;
        }
        /* Custom scrollbar for aesthetics */
        .scrollable-area::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-area::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }
        .scrollable-area::-webkit-scrollbar-thumb:hover {
            background-color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Header -->
    <header id="header" class="bg-indigo-pos shadow-lg text-white p-4 flex justify-between items-center sticky top-0 z-10">
        <div class="flex items-center space-x-2">
            <!-- DollarSign Icon (Lucide) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
            <h1 class="text-xl font-bold tracking-tight">RapidRepair POS (LKR)</h1>
        </div>
        <div class="text-sm flex items-center space-x-4">
            <button id="open-reports-btn" class="text-white hover:text-indigo-200 transition duration-150 p-2 rounded-full hover:bg-indigo-600" title="View Sales History and Reports">
                <!-- History Icon (Lucide) -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v6"/><path d="M15 22h-6"/><path d="M20 17v-2"/><path d="M4 17v-2"/><path d="M22 10V6c0-1.7-1.3-3-3-3h-3"/><path d="M2 10V6c0-1.7 1.3-3 3-3h3"/></svg>
            </button>
            <span id="user-info" class="hidden sm:inline">Clerk: Anonymous</span>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex flex-col md:flex-row overflow-hidden max-h-screen">

        <!-- Product Catalog (2/3 width on desktop) -->
        <div id="product-catalog" class="w-full md:w-2/3 flex-1 overflow-hidden">
            <div class="p-4 md:p-6 bg-gray-50 scrollable-area">
                
                <!-- Search and Filter Bar -->
                <div class="mb-6 bg-white p-4 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-2xl font-extrabold text-gray-900 mb-4 flex items-center">
                        <!-- LayoutGrid Icon (Lucide) -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-indigo-pos"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                        Product Catalog
                    </h2>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                        <div class="relative flex-grow">
                            <!-- Search Icon (Lucide) -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            <input
                                type="text"
                                id="search-term"
                                placeholder="Search parts (e.g., Battery, Screen...)"
                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition"
                            />
                        </div>
                        <select
                            id="category-filter"
                            class="w-full sm:w-auto border border-gray-300 rounded-lg py-2 px-4 focus:ring-indigo-500 focus:border-indigo-500 appearance-none bg-white transition"
                        >
                            <option value="All">All Categories</option>
                        </select>
                    </div>
                </div>
                
                <!-- Product Grid -->
                <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Products will be dynamically inserted here -->
                </div>
                
            </div>
        </div>

        <!-- Cart Sidebar (1/3 width on desktop) -->
        <div id="cart-sidebar" class="w-full md:w-1/3 h-auto md:h-screen flex-shrink-0 border-t md:border-l border-gray-300 bg-white flex flex-col">
            <div class="p-4 border-b shadow-sm flex items-center justify-between flex-shrink-0">
                <h3 class="text-lg font-bold text-gray-900 flex items-center">
                    <!-- ShoppingCart Icon (Lucide) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 text-indigo-pos"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 12.08a2 2 0 0 0 2 1.92h9.72a2 2 0 0 0 2-1.92L23 6H6"></path></svg>
                    Current Sale
                </h3>
                <span id="cart-total-display" class="text-xl font-extrabold text-indigo-pos">Rs. 0.00</span>
            </div>

            <!-- Cart Items List -->
            <div id="cart-items-list" class="flex-1 overflow-y-auto p-4 space-y-2 scrollable-area">
                <!-- Cart items will be dynamically inserted here -->
                <div id="empty-cart-message" class="text-center py-12 text-gray-400">
                    <!-- Package Icon (Lucide) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 mx-auto mb-2"><path d="M12.89 1.78l8 4-8 4-8-4 8-4z"/><path d="M21.91 10.74l-8 4-8-4"/></svg>
                    <p class="text-sm">Scan or add parts to start a transaction.</p>
                </div>
            </div>

            <!-- Cart Totals and Checkout Button -->
            <div class="p-4 border-t-2 border-indigo-100 bg-gray-50 flex-shrink-0">
                <div class="space-y-1 text-sm mb-4">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Subtotal:</span>
                        <span id="subtotal-amount" class="font-medium">Rs. 0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Tax (8%):</span>
                        <span id="tax-amount" class="font-medium">Rs. 0.00</span>
                    </div>
                    <div class="flex justify-between text-lg font-extrabold pt-2 border-t mt-2">
                        <span>TOTAL:</span>
                        <span id="final-total-amount" class="text-indigo-pos">Rs. 0.00</span>
                    </div>
                </div>

                <button
                    id="checkout-button"
                    class="w-full flex justify-center items-center space-x-2 py-3 px-4 rounded-xl text-white font-semibold shadow-xl transition duration-200
                        bg-emerald-pos hover:bg-emerald-600 disabled:bg-gray-400"
                    disabled
                >
                    <!-- DollarSign Icon (Lucide) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                    <span>Complete Sale</span>
                </button>
                <div id="checkout-message" class="text-center mt-2 text-sm text-green-700 hidden"></div>
            </div>
        </div>
    </main>

    <!-- Modal for Reports/History/Bill View -->
    <div id="reports-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex justify-center items-center p-4">
        <div class="bg-gray-50 w-full max-w-4xl h-full max-h-[90vh] rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <!-- Modal Header -->
            <div class="p-4 border-b bg-white flex justify-between items-center flex-shrink-0">
                <div class="flex space-x-2 border-b-2 border-transparent">
                    <button data-tab="History" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg transition duration-150 text-indigo-700 bg-indigo-100 border-indigo-500 border-b-2">History</button>
                    <button data-tab="Summary" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg transition duration-150 text-gray-600 hover:bg-gray-100">Summary</button>
                </div>
                <button id="close-reports-btn" class="p-2 text-gray-500 hover:bg-red-100 hover:text-red-600 rounded-full transition">
                    <!-- X Icon (Lucide) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
                </button>
            </div>
            <!-- Modal Body -->
            <div id="modal-body" class="flex-1 overflow-y-auto">
                <!-- Content will be rendered here (History, Summary, or BillView) -->
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- CONSTANTS AND CONFIGURATION ---
        const CURRENCY_SYMBOL = 'Rs.';
        const TAX_RATE = 0.08; // 8% tax rate
        const SUPABASE_URL = 'https://wmhwpplynxzyfjrzptrf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6ImpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtaHdwcGx5bnh6eWZqcnpwdHJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NDcwODEsImV4cCI6MjA3NzMyMzA4MX0.M8uVwysg0u695WkGK1v8fdAT09yjitOXa8eMPplto4w';

        // Mock Initial Data (Matches SQL insertion)
        let DUMMY_PRODUCTS = [
            { id: 1, name: 'iPhone 14 Pro Screen', price: 29999.99, stock: 15, category: 'Mobile Screens', image: 'https://placehold.co/40x40/4f46e5/ffffff?text=SCR' },
            { id: 2, name: 'Laptop Battery (Dell)', price: 8950.00, stock: 40, category: 'Laptop Parts', image: 'https://placehold.co/40x40/f97316/ffffff?text=BAT' },
            { id: 3, name: '10k Ohm Resistor (Pack of 100)', price: 499.99, stock: 500, category: 'Components', image: 'https://placehold.co/40x40/22c55e/ffffff?text=RES' },
            { id: 4, name: '256GB NVMe SSD', price: 5999.50, stock: 8, category: 'Storage', image: 'https://placehold.co/40x40/0ea5e9/ffffff?text=SSD' },
            { id: 5, name: 'MacBook Air Charger Port', price: 4500.00, stock: 22, category: 'Mobile Screens', image: 'https://placehold.co/40x40/ef4444/ffffff?text=PORT' },
            { id: 6, name: 'DDR4 16GB RAM Stick', price: 6500.00, stock: 12, category: 'Laptop Parts', image: 'https://placehold.co/40x40/a855f7/ffffff?text=RAM' },
        ];

        // --- STATE VARIABLES ---
        let products = DUMMY_PRODUCTS; // Current inventory
        let cart = []; // Current items in the cart
        let mockTransactions = []; // Sales history
        let user = { id: 'user_pos_123', email: 'pos.clerk@example.com' }; // Mock user
        let searchTerm = '';
        let categoryFilter = 'All';
        let loading = false;
        let checkoutStatus = null; // 'success', 'error', null
        let activeModalTab = 'History';
        let selectedTransaction = null;
        
        // --- DOM REFERENCES ---
        const productGrid = document.getElementById('product-grid');
        const cartItemsList = document.getElementById('cart-items-list');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const cartTotalDisplay = document.getElementById('cart-total-display');
        const subtotalAmount = document.getElementById('subtotal-amount');
        const taxAmount = document.getElementById('tax-amount');
        const finalTotalAmount = document.getElementById('final-total-amount');
        const checkoutButton = document.getElementById('checkout-button');
        const checkoutMessage = document.getElementById('checkout-message');
        const searchTermInput = document.getElementById('search-term');
        const categoryFilterSelect = document.getElementById('category-filter');
        const reportsModal = document.getElementById('reports-modal');
        const modalBody = document.getElementById('modal-body');

        // --- MOCK SUPABASE CLIENT (using provided keys) ---
        const supabase = {
            url: SUPABASE_URL,
            anonKey: SUPABASE_ANON_KEY,
            from: (tableName) => ({
                // Mocking select for products and transactions
                select: () => {
                    console.log(`MOCK SUPABASE: SELECT from ${tableName} (using local state)`);
                    if (tableName === 'products') return { data: products, error: null };
                    if (tableName === 'transactions') return { data: mockTransactions, error: null };
                    return { data: [], error: null };
                },
                // Mocking insert for transactions and update for stock
                insert: (data) => {
                    console.log(`MOCK SUPABASE: INSERT into ${tableName}`);
                    return { data: data, error: null };
                },
                update: (data) => {
                    console.log(`MOCK SUPABASE: UPDATE ${tableName} (Stock changes handled in app logic)`);
                    return { data: data, error: null };
                }
            }),
            auth: {
                signInAnonymously: () => new Promise(resolve => {
                    console.log('MOCK SUPABASE: Anonymous sign-in using provided key.');
                    setTimeout(() => resolve({ user: user, error: null }), 50);
                })
            }
        };

        // --- UTILITY FUNCTIONS ---

        /** Formats a number as currency string. */
        function formatCurrency(amount) {
            return `${CURRENCY_SYMBOL} ${amount.toFixed(2)}`;
        }

        /** Formats a date string for display. */
        function formatDate(dateString) {
            return new Date(dateString).toLocaleString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit',
            });
        }
        
        /** Calculates subtotal, tax, and total. */
        function calculateTotals() {
            const subtotal = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const tax = subtotal * TAX_RATE;
            const total = subtotal + tax;
            return { subtotal, tax, total };
        }

        /** Creates a unique 7-char transaction ID. */
        function generateTransactionId() {
            return Math.random().toString(36).substring(2, 9).toUpperCase();
        }

        // --- RENDERING FUNCTIONS ---

        /** Renders a single product card. */
        function renderProductCard(product) {
            const card = document.createElement('div');
            card.className = "bg-white border border-gray-200 rounded-xl shadow-md p-4 flex flex-col transition duration-300 hover:shadow-lg";

            const stockText = product.stock > 0 ? product.stock : 'Out of Stock';
            const stockColor = product.stock > 10 ? 'text-gray-500' : product.stock > 0 ? 'text-orange-500' : 'text-red-500';
            const buttonClass = product.stock > 0 ? 'bg-emerald-pos text-white hover:bg-emerald-600 shadow-md' : 'bg-gray-300 text-gray-600 cursor-not-allowed';

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="text-xs font-semibold text-indigo-600 bg-indigo-100 px-2 py-0.5 rounded-full">${product.category}</span>
                    <div class="w-10 h-10 rounded-lg overflow-hidden flex-shrink-0">
                        <img src="${product.image}" alt="${product.name}" class="w-full h-full object-cover"/>
                    </div>
                </div>
                <h3 class="text-sm font-semibold text-gray-800 truncate">${product.name}</h3>
                <div class="mt-auto pt-2 flex justify-between items-center">
                    <span class="text-xl font-bold text-gray-900">${formatCurrency(product.price)}</span>
                    <button
                        data-product-id="${product.id}"
                        class="add-to-cart-btn flex items-center space-x-1 px-3 py-1 text-sm font-medium rounded-lg transition duration-200 ${buttonClass}"
                        ${product.stock <= 0 ? 'disabled' : ''}
                    >
                        <!-- ShoppingCart Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 12.08a2 2 0 0 0 2 1.92h9.72a2 2 0 0 0 2-1.92L23 6H6"></path></svg>
                        <span>Add</span>
                    </button>
                </div>
                <p class="text-xs mt-1 ${stockColor}">
                    Stock: ${stockText}
                </p>
            `;
            return card;
        }

        /** Renders the entire product list based on filters. */
        function renderProductList() {
            productGrid.innerHTML = '';
            
            const filteredProducts = products.filter(product =>
                (categoryFilter === 'All' || product.category === categoryFilter) &&
                product.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (filteredProducts.length === 0) {
                productGrid.innerHTML = `<div class="col-span-full text-center py-10 text-gray-500">No products found matching your search or filter.</div>`;
            } else {
                filteredProducts.forEach(product => {
                    productGrid.appendChild(renderProductCard(product));
                });
            }
        }

        /** Renders the cart sidebar content. */
        function renderCart() {
            const { subtotal, tax, total } = calculateTotals();

            cartItemsList.innerHTML = '';
            
            if (cart.length === 0) {
                emptyCartMessage.classList.remove('hidden');
                checkoutButton.disabled = true;
            } else {
                emptyCartMessage.classList.add('hidden');
                checkoutButton.disabled = loading;
                cart.forEach(item => {
                    cartItemsList.appendChild(renderCartItem(item));
                });
            }

            // Update totals display
            cartTotalDisplay.textContent = formatCurrency(total);
            subtotalAmount.textContent = formatCurrency(subtotal);
            taxAmount.textContent = formatCurrency(tax);
            finalTotalAmount.textContent = formatCurrency(total);

            // Update checkout button text/status
            if (loading) {
                checkoutButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg><span>Processing...</span>`;
            } else if (checkoutStatus === 'success') {
                checkoutButton.innerHTML = `<!-- CheckCircle Icon --><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M9 11l3 3L22 4"/></svg><span>Transaction Complete!</span>`;
                checkoutMessage.textContent = 'Stock updated successfully.';
                checkoutMessage.classList.remove('hidden');
                checkoutButton.disabled = true;
                setTimeout(() => {
                    checkoutMessage.classList.add('hidden');
                    // Rerender to restore default button state
                    renderCart(); 
                }, 3000);
            } else {
                checkoutButton.innerHTML = `<!-- DollarSign Icon --><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg><span>Complete Sale</span>`;
                checkoutMessage.classList.add('hidden');
            }
        }

        /** Renders a single cart item. */
        function renderCartItem(item) {
            const div = document.createElement('div');
            div.className = "flex items-center justify-between py-3 border-b border-gray-100";
            
            div.innerHTML = `
                <div class="flex-1 min-w-0 pr-2">
                    <h4 class="text-sm font-medium text-gray-900 truncate">${item.name}</h4>
                    <p class="text-xs text-gray-500">${formatCurrency(item.price)} x ${item.quantity}</p>
                </div>
                <div class="flex items-center space-x-2">
                    <input
                        type="number"
                        min="1"
                        value="${item.quantity}"
                        data-item-id="${item.id}"
                        class="cart-quantity-input w-12 text-center text-sm border border-gray-300 rounded-md py-1 focus:ring-indigo-500"
                    />
                    <span class="text-sm font-semibold text-gray-700 w-16 text-right">${formatCurrency(item.price * item.quantity)}</span>
                    <button
                        data-item-id="${item.id}"
                        class="remove-from-cart-btn p-1 text-red-500 hover:bg-red-50 rounded-full transition"
                    >
                        <!-- X Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
                    </button>
                </div>
            `;
            return div;
        }

        /** Renders the categories in the filter dropdown. */
        function renderCategories() {
            const categories = ['All', ...new Set(products.map(p => p.category))];
            categoryFilterSelect.innerHTML = categories.map(cat => 
                `<option value="${cat}">${cat}</option>`
            ).join('');
        }
        
        // --- MODAL RENDERING FUNCTIONS ---
        
        function renderModal() {
            if (selectedTransaction) {
                renderBillView(selectedTransaction);
            } else if (activeModalTab === 'Summary') {
                renderSalesSummary();
            } else {
                renderTransactionHistory();
            }
        }

        function renderBillView(transaction) {
            modalBody.innerHTML = `
                <div class="p-6">
                    <button id="back-to-history" class="text-indigo-600 hover:text-indigo-800 flex items-center mb-4">
                        &larr; Back to History
                    </button>
                    <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-100">
                        <div class="flex justify-between border-b pb-3 mb-4">
                            <h3 class="text-2xl font-bold text-gray-900">Purchase Bill (LKR)</h3>
                            <span class="text-sm font-mono text-gray-500">TXN #${transaction.id}</span>
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-4">
                            <strong>Date:</strong> ${formatDate(transaction.transaction_date)}
                        </p>

                        <!-- Items Table -->
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                        <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${transaction.items_sold.map((item) => `
                                        <tr>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-right">${item.quantity}</td>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm text-right">${formatCurrency(item.price)}</td>
                                            <td class="px-3 py-2 whitespace-nowrap text-sm font-bold text-right">${formatCurrency(item.price * item.quantity)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <!-- Summary Totals -->
                        <div class="mt-6 pt-4 border-t-2 border-dashed border-gray-300">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-600">Subtotal:</span>
                                <span class="font-medium">${formatCurrency(transaction.subtotal)}</span>
                            </div>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-gray-600">Tax (${TAX_RATE * 100}%):</span>
                                <span class="font-medium">${formatCurrency(transaction.tax)}</span>
                            </div>
                            <div class="flex justify-between text-xl font-extrabold text-indigo-600">
                                <span>Grand Total:</span>
                                <span>${formatCurrency(transaction.total_amount)}</span>
                            </div>
                        </div>

                        <div class="text-center mt-6 p-3 bg-indigo-50 rounded-lg text-sm text-indigo-800">
                            Thank you for choosing RapidRepair!
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('back-to-history').addEventListener('click', () => {
                selectedTransaction = null;
                renderModal();
            });
        }

        function renderTransactionHistory() {
            modalBody.innerHTML = `
                <div class="p-4 space-y-4">
                    <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                        <!-- History Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-indigo-pos"><path d="M12 2v6"/><path d="M15 22h-6"/><path d="M20 17v-2"/><path d="M4 17v-2"/><path d="M22 10V6c0-1.7-1.3-3-3-3h-3"/><path d="M2 10V6c0-1.7 1.3-3 3-3h3"/></svg>
                        Transaction History
                    </h3>
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-x-auto">
                        ${mockTransactions.length === 0 ? `
                            <div class="p-10 text-center text-gray-500">No transactions recorded yet.</div>
                        ` : `
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">View</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${mockTransactions.map(tx => `
                                        <tr class="hover:bg-indigo-50 transition duration-150">
                                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900 truncate max-w-xs sm:max-w-none">${tx.id}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">${formatDate(tx.transaction_date)}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-sm font-semibold text-right text-indigo-700">${formatCurrency(tx.total_amount)}</td>
                                            <td class="px-4 py-2 whitespace-nowrap text-center">
                                                <button data-tx-id="${tx.id}" class="view-bill-btn text-indigo-600 hover:text-indigo-800 text-xs font-semibold">
                                                    View Bill
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `}
                    </div>
                </div>
            `;
            document.querySelectorAll('.view-bill-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const txId = e.target.dataset.txId;
                    selectedTransaction = mockTransactions.find(tx => tx.id === txId);
                    renderModal();
                });
            });
        }
        
        function renderSalesSummary() {
            const summaryData = calculateSummary();

            const SummaryCard = (title, iconSvg, value, count, color) => `
                <div class="bg-white p-4 rounded-xl shadow-lg border-l-4 ${color} flex flex-col justify-between">
                    <div class="flex items-center justify-between">
                        <h4 class="text-sm font-medium text-gray-500">${title}</h4>
                        ${iconSvg}
                    </div>
                    <div class="mt-2">
                        <p class="text-3xl font-extrabold text-gray-900">${formatCurrency(value)}</p>
                        <p class="text-sm text-gray-500 mt-1">${count} Transactions</p>
                    </div>
                </div>
            `;

            const clockIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-green-500"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>';
            const calendarIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-indigo-500"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>';

            modalBody.innerHTML = `
                <div class="p-4 space-y-6">
                    <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                        <!-- BookOpen Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2 text-indigo-pos"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                        Sales Summary
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        ${SummaryCard("Today's Sales", clockIcon, summaryData.dailySales, summaryData.dailyCount, "border-green-500")}
                        ${SummaryCard("Monthly Sales", calendarIcon, summaryData.monthlySales, summaryData.monthlyCount, "border-indigo-500")}
                    </div>
                    <p class="text-sm text-gray-500 pt-4 border-t">
                        This report is generated from the <strong>${mockTransactions.length}</strong> mock transactions recorded in this session.
                    </p>
                </div>
            `;
        }

        function calculateSummary() {
            const today = new Date().toDateString();
            const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);

            let dailySales = 0;
            let dailyCount = 0;
            let monthlySales = 0;
            let monthlyCount = 0;

            mockTransactions.forEach(tx => {
                const txDate = new Date(tx.transaction_date);
                const txDateString = txDate.toDateString();

                if (txDateString === today) {
                    dailySales += tx.total_amount;
                    dailyCount++;
                }

                if (txDate >= startOfMonth) {
                    monthlySales += tx.total_amount;
                    monthlyCount++;
                }
            });

            return { dailySales, dailyCount, monthlySales, monthlyCount };
        }

        // --- CORE APPLICATION LOGIC ---

        /** Initializes the application state and renders components. */
        async function initApp() {
            try {
                // 1. Mock Auth
                const authResult = await supabase.auth.signInAnonymously();
                if (authResult.user) {
                    user = authResult.user;
                    document.getElementById('user-info').textContent = `Clerk: ${user.email}`;
                }

                // 2. Fetch/Load Products (using mock data)
                const { data } = supabase.from('products').select();
                products = data;
                
                // 3. Initial Render
                renderCategories();
                renderProductList();
                renderCart();
            } catch (err) {
                console.error("Initialization failed:", err);
                // Handle UI error display if necessary
            }
        }

        /** Adds a product to the cart. */
        function addToCart(productId) {
            setCheckoutStatus(null);
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item.id === productId);

            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    cart = cart.map(item =>
                        item.id === productId ? { ...item, quantity: item.quantity + 1 } : item
                    );
                } else {
                    console.warn("Cannot add more: Stock limit reached.");
                }
            } else {
                cart = [...cart, { ...product, quantity: 1 }];
            }

            renderCart();
            renderProductList(); // Re-render to update stock numbers visually if needed
        }

        /** Updates the quantity of a cart item. */
        function updateCartQuantity(itemId, newQuantity) {
            setCheckoutStatus(null);
            const productId = parseInt(itemId);
            newQuantity = parseInt(newQuantity);

            if (newQuantity < 1) return;

            const productStock = products.find(p => p.id === productId)?.stock || 0;
            const effectiveQuantity = Math.min(newQuantity, productStock);
            
            cart = cart.map(item => {
                if (item.id === productId) {
                    return { ...item, quantity: effectiveQuantity };
                }
                return item;
            }).filter(item => item.quantity > 0);

            renderCart();
            renderProductList();
        }

        /** Removes an item from the cart. */
        function removeFromCart(itemId) {
            setCheckoutStatus(null);
            const productId = parseInt(itemId);
            cart = cart.filter(item => item.id !== productId);
            renderCart();
            renderProductList();
        }

        /** Handles the checkout process. */
        async function processCheckout() {
            if (cart.length === 0 || loading) return;
            loading = true;
            renderCart(); // Show loading state

            const totals = calculateTotals();

            try {
                // A. Create Transaction Record (Mock Persistence)
                const transactionData = {
                    id: generateTransactionId(),
                    user_id: user.id,
                    total_amount: totals.total,
                    subtotal: totals.subtotal,
                    tax: totals.tax,
                    items_sold: JSON.parse(JSON.stringify(cart)), // Deep clone for history
                    transaction_date: new Date().toISOString(),
                    total_amount: totals.total // Ensure amount is saved
                };

                // Mock database insert
                const { error: txError } = supabase.from('transactions').insert(transactionData);
                if (txError) throw txError;
                
                // **PERSIST TRANSACTION LOCALLY**
                mockTransactions = [transactionData, ...mockTransactions]; 
                console.log("Mock Transaction recorded:", transactionData.id);

                // B. Update Product Stock (Mock Persistence)
                const updates = [];
                const newProducts = products.map(p => {
                    const cartItem = cart.find(item => item.id === p.id);
                    if (cartItem) {
                        const newStock = p.stock - cartItem.quantity;
                        if (newStock < 0) {
                            throw new Error(`Stock error for ${p.name}. Only ${p.stock} left.`);
                        }
                        updates.push({ id: p.id, stock: newStock });
                        return { ...p, stock: newStock };
                    }
                    return p;
                });
                products = newProducts;
                
                // Mock database update
                supabase.from('products').update(updates);
                
                // C. Finalize
                cart = [];
                checkoutStatus = 'success';

            } catch (error) {
                console.error("Checkout Failed:", error);
                checkoutStatus = 'error';
                alert('Checkout failed! ' + error.message);
            } finally {
                loading = false;
                renderCart();
                renderProductList(); // Update stock in product list
            }
        }

        // --- EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            initApp();

            // Product Catalog Listeners (Delegation)
            productGrid.addEventListener('click', (e) => {
                if (e.target.closest('.add-to-cart-btn')) {
                    const btn = e.target.closest('.add-to-cart-btn');
                    addToCart(parseInt(btn.dataset.productId));
                }
            });

            // Cart Sidebar Listeners (Delegation)
            cartItemsList.addEventListener('click', (e) => {
                if (e.target.closest('.remove-from-cart-btn')) {
                    const btn = e.target.closest('.remove-from-cart-btn');
                    removeFromCart(btn.dataset.itemId);
                }
            });

            cartItemsList.addEventListener('change', (e) => {
                if (e.target.classList.contains('cart-quantity-input')) {
                    const input = e.target;
                    updateCartQuantity(input.dataset.itemId, input.value);
                }
            });

            // Checkout Listener
            checkoutButton.addEventListener('click', processCheckout);

            // Search and Filter Listeners
            searchTermInput.addEventListener('input', (e) => {
                searchTerm = e.target.value;
                renderProductList();
            });

            categoryFilterSelect.addEventListener('change', (e) => {
                categoryFilter = e.target.value;
                renderProductList();
            });
            
            // Reports Modal Listeners
            document.getElementById('open-reports-btn').addEventListener('click', () => {
                reportsModal.classList.remove('hidden');
                activeModalTab = 'History';
                selectedTransaction = null;
                // Re-apply correct tab styling
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'border-indigo-500', 'border-b-2');
                    btn.classList.add('text-gray-600', 'hover:bg-gray-100');
                    if (btn.dataset.tab === 'History') {
                        btn.classList.add('bg-indigo-100', 'text-indigo-700', 'border-indigo-500', 'border-b-2');
                        btn.classList.remove('text-gray-600', 'hover:bg-gray-100');
                    }
                });
                renderModal();
            });

            document.getElementById('close-reports-btn').addEventListener('click', () => {
                reportsModal.classList.add('hidden');
            });
            
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    // Update active tab state and styling
                    document.querySelectorAll('.tab-button').forEach(btn => {
                        btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'border-indigo-500', 'border-b-2');
                        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
                    });
                    
                    e.target.classList.add('bg-indigo-100', 'text-indigo-700', 'border-indigo-500', 'border-b-2');
                    e.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
                    
                    activeModalTab = e.target.dataset.tab;
                    selectedTransaction = null;
                    renderModal();
                });
            });

        });
    </script>
</body>
</html>
